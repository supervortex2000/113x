From 7fe4090e03018b67ca90548817120b5e8d1c76fa Mon Sep 17 00:00:00 2001
From: Song Zhao <song.zhao@amlogic.com>
Date: Mon, 22 Mar 2021 18:00:27 -0700
Subject: [PATCH] sink new avsync support

Change-Id: I3836c589b06fa83f68695714677dd8e4f4832070
---
 westeros-sink/v4l2/Makefile.am         |  5 +-
 westeros-sink/v4l2/westeros-sink-soc.c | 95 +++++++++++++++++---------
 westeros-sink/v4l2/westeros-sink-soc.h |  1 +
 3 files changed, 68 insertions(+), 33 deletions(-)

diff --git a/westeros-sink/v4l2/Makefile.am b/westeros-sink/v4l2/Makefile.am
index ccd3218..97c703e 100644
--- a/westeros-sink/v4l2/Makefile.am
+++ b/westeros-sink/v4l2/Makefile.am
@@ -50,9 +50,10 @@ libgstwesterossink_la_LDFLAGS= \
    $(GST_LIBS)  $(GSTBASE_LIBS) $(WAYLANDLIB) -avoid-version \
    -ldrm -lgbm \
    -lessosrmgr \
-   -lwesteros_compositor \
+	 -lwesteros_compositor \
    -lwesteros_simplebuffer_client \
-   -lwesteros_simpleshell_client
+   -lwesteros_simpleshell_client \
+   -L$(STAGING_DIR)/usr/lib/gstreamer-1.0 -lgstamlhalasink
    
 distcleancheck_listfiles = *-libtool
 
diff --git a/westeros-sink/v4l2/westeros-sink-soc.c b/westeros-sink/v4l2/westeros-sink-soc.c
index 1108aaa..1746c81 100644
--- a/westeros-sink/v4l2/westeros-sink-soc.c
+++ b/westeros-sink/v4l2/westeros-sink-soc.c
@@ -30,6 +30,10 @@
 #include <dirent.h>
 #include <fcntl.h>
 #include <poll.h>
+#ifdef USE_AMLOGIC_MESON
+#include "gstamlclock.h"
+#include "gstamlhalasink_new.h"
+#endif
 
 #ifdef USE_GST_VIDEO
 #include <gst/video/video-color.h>
@@ -87,6 +91,8 @@ enum
   PROP_VIDEO_PLANE_SWITCH,
   PROP_VIDEO_FRAME_DROP_NUM,
   PROP_FRAME_STEP_ON_PREROLL,
+  PROP_AVSYNC_SESSION,
+  PROP_AVSYNC_MODE,
   PROP_LOW_MEMORY_MODE,
   PROP_FORCE_ASPECT_RATIO,
   PROP_WINDOW_SHOW,
@@ -348,6 +354,16 @@ void gst_westeros_sink_soc_class_init(GstWesterosSinkClass *klass)
        g_param_spec_boolean ("pip", "pip",
            "video picture in picture",
            FALSE, G_PARAM_WRITABLE));
+#ifdef USE_AMLOGIC_MESON
+   g_object_class_install_property (G_OBJECT_CLASS (klass), PROP_AVSYNC_SESSION,
+     g_param_spec_int ("avsync-session", "avsync session",
+                       "avsync session id to link video and audio. If set, this sink won't look for it from audio sink",
+                       G_MININT, G_MAXINT, 0, G_PARAM_WRITABLE));
+   g_object_class_install_property (G_OBJECT_CLASS (klass), PROP_AVSYNC_MODE,
+     g_param_spec_int ("avsync-mode", "avsync mode",
+                       "Vmaster(0) Amaster(1) PCRmaster(2) IPTV(3) FreeRun(4)",
+                       G_MININT, G_MAXINT, 0, G_PARAM_WRITABLE));
+#endif
 
    g_object_class_install_property (G_OBJECT_CLASS (klass), PROP_VIDEO_FRAME_DROP_NUM,
        g_param_spec_int ("frames-dropped", "frames-dropped",
@@ -546,7 +562,7 @@ gboolean gst_westeros_sink_soc_init( GstWesterosSink *sink )
    sink->soc.formatsSet= FALSE;
    sink->soc.updateSession= FALSE;
    sink->soc.syncType= -1;
-   sink->soc.sessionId= 0;
+   sink->soc.sessionId= -1;
    sink->soc.bufferCohort= 0;
    sink->soc.minBuffersIn= 0;
    sink->soc.minBuffersOut= 0;
@@ -734,6 +750,27 @@ void gst_westeros_sink_soc_set_property(GObject *object, guint prop_id, const GV
          GST_WARNING_OBJECT(sink, "pip video enabled %d", sink->soc.pip);
          break;
       }
+      case PROP_AVSYNC_SESSION:
+         {
+            int id = g_value_get_int (value);
+            if (id >= 0)
+            {
+               sink->soc.userSession= TRUE;
+               sink->soc.sessionId= id;
+               GST_WARNING("AV sync session %d", id);
+            }
+            break;
+         }
+      case PROP_AVSYNC_MODE:
+         {
+            int mode = g_value_get_int (value);
+            if (mode >= 0)
+            {
+               sink->soc.syncType= mode;
+               GST_WARNING("AV sync mode %d", mode);
+            }
+            break;
+         }
       case PROP_LOW_MEMORY_MODE:
          {
             sink->soc.lowMemoryMode= g_value_get_boolean(value);
@@ -825,6 +862,12 @@ void gst_westeros_sink_soc_get_property(GObject *object, guint prop_id, GValue *
       case PROP_FRAME_STEP_ON_PREROLL:
          g_value_set_boolean(value, sink->soc.frameStepOnPreroll);
          break;
+      case PROP_AVSYNC_SESSION:
+         g_value_set_int (value, sink->soc.sessionId);
+         break;
+      case PROP_AVSYNC_MODE:
+         g_value_set_int (value, sink->soc.syncType);
+         break;
       case PROP_LOW_MEMORY_MODE:
          g_value_set_boolean(value, sink->soc.lowMemoryMode);
          break;
@@ -3779,6 +3822,7 @@ static GstElement* wstFindAudioSink( GstWesterosSink *sink )
 static void wstSetSessionInfo( GstWesterosSink *sink )
 {
    #ifdef USE_AMLOGIC_MESON
+   #define INVALID_SEESION_ID 16
    if ( sink->soc.conn )
    {
       GstElement *audioSink;
@@ -3786,43 +3830,32 @@ static void wstSetSessionInfo( GstWesterosSink *sink )
       GstClock *clock= GST_ELEMENT_CLOCK(element);
       int syncTypePrev= sink->soc.syncType;
       int sessionIdPrev= sink->soc.sessionId;
+
+      if (sink->soc.userSession)
+      {
+         wstSendSessionInfoVideoClientConnection( sink->soc.conn );
+         return;
+      }
+
       sink->soc.syncType= 0;
-      sink->soc.sessionId= 0;
+      /* for video only case, let render create session */
+      sink->soc.sessionId= INVALID_SEESION_ID;
       audioSink= wstFindAudioSink( sink );
       if ( audioSink )
       {
-         sink->soc.syncType= 1;
-         gst_object_unref( audioSink );
-      }
-      if ( clock )
-      {
-         const char *socClockName;
-         gchar *clockName;
-         clockName= gst_object_get_name(GST_OBJECT_CAST(clock));
-         if ( clockName )
+         GstClock* amlclock= gst_aml_hal_asink_get_clock( audioSink );
+         if (amlclock)
          {
-            int sclen;
-            int len= strlen(clockName);
-            socClockName= getenv("WESTEROS_SINK_CLOCK");
-            if ( !socClockName )
-            {
-               socClockName= "GstAmlSinkClock";
-            }
-            sclen= strlen(socClockName);
-            if ( (len == sclen) && !strncmp(clockName, socClockName, len) )
-            {
-               sink->soc.syncType= 1;
-               /* TBD: set sessionid */
-            }
-            g_free( clockName );
+            sink->soc.syncType= 1;
+            sink->soc.sessionId= gst_aml_clock_get_session_id( amlclock );
+            gst_object_unref( amlclock );
+         } else {
+	    /* audio is not master */
+            GST_WARNING ("no clock vmaster mode");
          }
+         gst_object_unref( audioSink );
+         GST_WARNING("AmlHalAsink detected, sesison_id: %d", sink->soc.sessionId);
       }
-
-      if (sink->soc.pip) {
-         sink->soc.syncType= 0;
-         sink->soc.sessionId= 1;//pip session
-      }
-
       if ( (syncTypePrev != sink->soc.syncType) || (sessionIdPrev != sink->soc.sessionId) )
       {
          wstSendSessionInfoVideoClientConnection( sink->soc.conn );
diff --git a/westeros-sink/v4l2/westeros-sink-soc.h b/westeros-sink/v4l2/westeros-sink-soc.h
index 1dbd465..68ca1b8 100644
--- a/westeros-sink/v4l2/westeros-sink-soc.h
+++ b/westeros-sink/v4l2/westeros-sink-soc.h
@@ -156,6 +156,7 @@ struct _GstWesterosSinkSoc
    gboolean updateSession;
    int syncType;
    int sessionId;
+   gboolean userSession;
    int bufferCohort;
    uint32_t minBuffersIn;
    uint32_t minBuffersOut;
-- 
2.31.0

