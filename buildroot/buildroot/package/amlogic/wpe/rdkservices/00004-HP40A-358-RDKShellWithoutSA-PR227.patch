From 590230d88b3c8f23897dc9ba16b7aeebdd8f0a0b Mon Sep 17 00:00:00 2001
From: mfiess200 <michael_fiess@cable.comcast.com>
Date: Wed, 2 Sep 2020 18:07:43 -0400
Subject: [PATCH] ability to compile without security agent

---
 RDKShell/CMakeLists.txt |   5 ++
 RDKShell/RDKShell.cpp   | 148 +++++++++++++++++++++-------------------
 2 files changed, 83 insertions(+), 70 deletions(-)

diff --git a/RDKShell/CMakeLists.txt b/RDKShell/CMakeLists.txt
index a922266..098c838 100755
--- a/RDKShell/CMakeLists.txt
+++ b/RDKShell/CMakeLists.txt
@@ -17,9 +17,14 @@
 
 set(PLUGIN_NAME RDKShell)
 set(MODULE_NAME ${NAMESPACE}${PLUGIN_NAME})
+option(ENABLE_RDKSHELL_SECURITY_TOKEN "ENABLE_RDKSHELL_SECURITY_TOKEN" OFF)
 
 find_package(${NAMESPACE}Plugins REQUIRED)
 
+if (ENABLE_RDKSHELL_SECURITY_TOKEN)
+    add_definitions(-DENABLE_SECURITY_TOKEN)
+endif (ENABLE_RDKSHELL_SECURITY_TOKEN)
+
 add_library(${MODULE_NAME} SHARED
         RDKShell.cpp
         Module.cpp
diff --git a/RDKShell/RDKShell.cpp b/RDKShell/RDKShell.cpp
index 8e1ebab..24a4285 100755
--- a/RDKShell/RDKShell.cpp
+++ b/RDKShell/RDKShell.cpp
@@ -22,7 +22,9 @@
 #include <iostream>
 #include <mutex>
 #include <thread>
+#ifdef ENABLE_SECURITY_TOKEN
 #include <securityagent/SecurityTokenUtil.h>
+#endif //ENABLE_SECURITY_TOKEN
 #include <curl/curl.h>
 #include <rdkshell/compositorcontroller.h>
 #include <rdkshell/application.h>
@@ -360,91 +362,97 @@ namespace WPEFramework {
 
         void RDKShell::getSecurityToken(std::string& token)
         {
-            if(m_sThunderSecurityChecked)
-            {
-                return;
-            }
-            
-            // Thunder Security is enabled by Default.
-            bool thunderSecurityRFCEnabled = true;
-            RFC_ParamData_t param;
-            if (getRFCConfig("Device.DeviceInfo.X_RDKCENTRAL-COM_RFC.Feature.ThunderSecurity.Enable", param))
-            {
-                if (param.type == WDMP_BOOLEAN && (strncasecmp(param.value,"false",5) == 0))
+            #ifdef ENABLE_SECURITY_TOKEN
+                if(m_sThunderSecurityChecked)
                 {
-                    thunderSecurityRFCEnabled = false;
+                    return;
+                }
+                
+                // Thunder Security is enabled by Default.
+                bool thunderSecurityRFCEnabled = true;
+                RFC_ParamData_t param;
+                if (getRFCConfig("Device.DeviceInfo.X_RDKCENTRAL-COM_RFC.Feature.ThunderSecurity.Enable", param))
+                {
+                    if (param.type == WDMP_BOOLEAN && (strncasecmp(param.value,"false",5) == 0))
+                    {
+                        thunderSecurityRFCEnabled = false;
+                    }
+                }
+                std::cout << "Thunder Security RFC enabled: " << thunderSecurityRFCEnabled << std::endl;
+                if(!isThunderSecurityConfigured() || !thunderSecurityRFCEnabled)
+                {
+                    m_sThunderSecurityChecked = true;
+                    std::cout << "Thunder Security is not enabled. Not getting token\n";
+                    return;
                 }
-            }
-            std::cout << "Thunder Security RFC enabled: " << thunderSecurityRFCEnabled << std::endl;
-            if(!isThunderSecurityConfigured() || !thunderSecurityRFCEnabled)
-            {
                 m_sThunderSecurityChecked = true;
-                std::cout << "Thunder Security is not enabled. Not getting token\n";
-                return;
-            }
-            m_sThunderSecurityChecked = true;
-            unsigned char buffer[MAX_STRING_LENGTH] = {0};
-            
-            int ret = GetSecurityToken(MAX_STRING_LENGTH,buffer);
-            if(ret < 0)
-            {
-                std::cout << "Error in getting token\n";
-            }
-            else
-            {
-                std::cout << "retrieved token successfully\n";
-                token = (char*)buffer;
-            }
+                unsigned char buffer[MAX_STRING_LENGTH] = {0};
+                
+                int ret = GetSecurityToken(MAX_STRING_LENGTH,buffer);
+                if(ret < 0)
+                {
+                    std::cout << "Error in getting token\n";
+                }
+                else
+                {
+                    std::cout << "retrieved token successfully\n";
+                    token = (char*)buffer;
+                }
+            #endif //ENABLE_SECURITY_TOKEN
         }
 
         bool RDKShell::isThunderSecurityConfigured()
         {
-            bool configured = false;
-            long http_code = 0;
-            std::string jsonResp;
-            CURL *curl_handle = NULL;
-            CURLcode res = CURLE_OK;
-            curl_handle = curl_easy_init();
-            string serialNumber = "";
-            string url = "http://127.0.0.1:9998/Service/Controller/Configuration/Controller";
-            if (curl_handle && 
-                !curl_easy_setopt(curl_handle, CURLOPT_URL, url.c_str()) &&
-                !curl_easy_setopt(curl_handle, CURLOPT_HTTPGET,1) &&
-                !curl_easy_setopt(curl_handle, CURLOPT_FOLLOWLOCATION, 1) && //when redirected, follow the redirections
-                !curl_easy_setopt(curl_handle, CURLOPT_WRITEFUNCTION, writeCurlResponse) &&
-                !curl_easy_setopt(curl_handle, CURLOPT_WRITEDATA, &jsonResp)) {
-                
-                res = curl_easy_perform(curl_handle);
-                if(curl_easy_getinfo(curl_handle, CURLINFO_RESPONSE_CODE, &http_code) != CURLE_OK)
+            #ifdef ENABLE_SECURITY_TOKEN
+                return false;
+            #else
+                bool configured = false;
+                long http_code = 0;
+                std::string jsonResp;
+                CURL *curl_handle = NULL;
+                CURLcode res = CURLE_OK;
+                curl_handle = curl_easy_init();
+                string serialNumber = "";
+                string url = "http://127.0.0.1:9998/Service/Controller/Configuration/Controller";
+                if (curl_handle && 
+                    !curl_easy_setopt(curl_handle, CURLOPT_URL, url.c_str()) &&
+                    !curl_easy_setopt(curl_handle, CURLOPT_HTTPGET,1) &&
+                    !curl_easy_setopt(curl_handle, CURLOPT_FOLLOWLOCATION, 1) && //when redirected, follow the redirections
+                    !curl_easy_setopt(curl_handle, CURLOPT_WRITEFUNCTION, writeCurlResponse) &&
+                    !curl_easy_setopt(curl_handle, CURLOPT_WRITEDATA, &jsonResp)) {
+                    
+                    res = curl_easy_perform(curl_handle);
+                    if(curl_easy_getinfo(curl_handle, CURLINFO_RESPONSE_CODE, &http_code) != CURLE_OK)
+                    {
+                        std::cout << "curl_easy_getinfo failed\n";
+                    }
+                    std::cout << "Thunder Controller Configuration ret: " << res << " http response code: " << http_code << std::endl;
+                    curl_easy_cleanup(curl_handle);
+                }
+                else
                 {
-                    std::cout << "curl_easy_getinfo failed\n";
+                    std::cout << "Could not perform curl to read Thunder Controller Configuration\n";
                 }
-                std::cout << "Thunder Controller Configuration ret: " << res << " http response code: " << http_code << std::endl;
-                curl_easy_cleanup(curl_handle);
-            }
-            else
-            {
-                std::cout << "Could not perform curl to read Thunder Controller Configuration\n";
-            }
-            if ((res == CURLE_OK) && (http_code == 200))
-            {
-                //check for "Security" in response
-                JsonObject responseJson = JsonObject(jsonResp);
-                if (responseJson.HasLabel("subsystems"))
+                if ((res == CURLE_OK) && (http_code == 200))
                 {
-                    const JsonArray subsystemList = responseJson["subsystems"].Array();
-                    for (int i=0; i<subsystemList.Length(); i++)
+                    //check for "Security" in response
+                    JsonObject responseJson = JsonObject(jsonResp);
+                    if (responseJson.HasLabel("subsystems"))
                     {
-                        string subsystem = subsystemList[i].String();
-                        if (subsystem == "Security")
+                        const JsonArray subsystemList = responseJson["subsystems"].Array();
+                        for (int i=0; i<subsystemList.Length(); i++)
                         {
-                            configured = true;
-                            break;
+                            string subsystem = subsystemList[i].String();
+                            if (subsystem == "Security")
+                            {
+                                configured = true;
+                                break;
+                            }
                         }
                     }
                 }
-            }
-            return configured;
+                return configured;
+            #endif //ENABLE_SECURITY_TOKEN
         }
 
         void RDKShell::RdkShellListener::onApplicationLaunched(const std::string& client)
