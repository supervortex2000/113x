From b86cc11896c3b671779d49022ef957ca224df303 Mon Sep 17 00:00:00 2001
From: Arun P Madhavan <arun_madhavan@comcast.com>
Date: Thu, 9 Jul 2020 16:10:29 +0000
Subject: [PATCH] HP40A-100-AML-ActiveStandby-PassiveStandby-supports

---
 Power/CMakeLists.txt                          |  3 ++
 .../Linux/MFRPersistPower.cpp                 | 12 +++++
 .../Linux/PowerImplementation.cpp             | 11 ++++-
 cmake/FindMFRAVCtrl.cmake                     | 47 +++++++++++++++++++
 4 files changed, 72 insertions(+), 1 deletion(-)
 create mode 100644 cmake/FindMFRAVCtrl.cmake

diff --git a/Power/CMakeLists.txt b/Power/CMakeLists.txt
index 6965435..32c029e 100644
--- a/Power/CMakeLists.txt
+++ b/Power/CMakeLists.txt
@@ -54,12 +54,15 @@ target_include_directories( ${MODULE_NAME}
 
 find_package(BcmPowerManager QUIET)
 find_package(MFRPwrMgrLibs QUIET)
+find_package(MFRAVCtrl QUIET)
 
 if(${PLUGIN_POWER_MFRPERSIST_STATE} STREQUAL ON AND MFRPWRMGRLIBS_FOUND)
     message("Enabling Persistent power state feature...")
     target_sources(${MODULE_NAME} PRIVATE
         PowerImplementation/${PLUGIN_POWER_IMPLEMENTATION}/MFRPersistPower.cpp)
     target_link_libraries(${MODULE_NAME} PRIVATE pwrmgrlibs::pwrmgrlibs)
+    message("MFRAVCtrl '${MFRAVCtrl_FOUND}'")
+    target_link_libraries(${MODULE_NAME} PRIVATE avctrllibs::avctrllibs)
 else()
     target_sources(${MODULE_NAME} PRIVATE
         PowerImplementation/Stub/MFRPersistPowerStub.cpp)
diff --git a/Power/PowerImplementation/Linux/MFRPersistPower.cpp b/Power/PowerImplementation/Linux/MFRPersistPower.cpp
index 5b3c732..84e53c7 100644
--- a/Power/PowerImplementation/Linux/MFRPersistPower.cpp
+++ b/Power/PowerImplementation/Linux/MFRPersistPower.cpp
@@ -26,6 +26,7 @@
 
 extern "C" {
 #include "mfrPowerMgr.h"
+#include "mfrAVCtrl.h"
 }
 
 enum WPEFramework::Exchange::IPower::PCState power_get_persisted_state()
@@ -49,5 +50,16 @@ void power_set_persisted_state(const enum WPEFramework::Exchange::IPower::PCStat
     } else {
         /* Nothing to do here. */
     }
+
+    /* HP40A-100: Power plugin behavioral issues - fix. */
+    if (WPEFramework::Exchange::IPower::PCState::On == persistedState) {
+        /* Enable Audio and Video Outputs. */
+        enableVideoOutput(true);
+        enableAudioOutput(true);
+    } else {
+        /* Disable Audio and Video Outputs. */
+        enableVideoOutput(false);
+        enableAudioOutput(false);
+    }
 }
 
diff --git a/Power/PowerImplementation/Linux/PowerImplementation.cpp b/Power/PowerImplementation/Linux/PowerImplementation.cpp
index f56b603..ee25322 100644
--- a/Power/PowerImplementation/Linux/PowerImplementation.cpp
+++ b/Power/PowerImplementation/Linux/PowerImplementation.cpp
@@ -119,6 +119,10 @@ public:
 
         /* Add POWEROFF & ON since its software implementation. */
         _supportedModes |= ((1 << Exchange::IPower::PCState::PowerOff) | (1 <<  Exchange::IPower::PCState::On));
+        /* HP40A-100: PassiveStandby = STR mode as Amlogic supported feature. */
+        /* HP40A-100: ActiveStandby -> mute HDMI and SPDIF out; added in mfr section. */
+        _supportedModes |= ((1 << Exchange::IPower::PCState::PassiveStandby)
+                | (1 << Exchange::IPower::PCState::ActiveStandby));
         TRACE(Trace::Information, (_T("Supported Power Modes : %d"), _supportedModes));
 
         _stateFile = ::open(StateFile, O_WRONLY);
@@ -200,7 +204,12 @@ private:
                 switch (state) {
                     case Exchange::IPower::PCState::On: break;
                     case Exchange::IPower::PCState::ActiveStandby: break;
-                    case Exchange::IPower::PCState::PassiveStandby: break;
+                    case Exchange::IPower::PCState::PassiveStandby:
+                        {
+                            /* HP40A-100: PassiveStandby = STR; trigger proper STR. */
+                            SetState(Exchange::IPower::PCState::SuspendToRAM, 0);
+                        }
+                        break;
                     case Exchange::IPower::PCState::SuspendToRAM:
                         {
                             ::write(_triggerFile, "1", 1);
diff --git a/cmake/FindMFRAVCtrl.cmake b/cmake/FindMFRAVCtrl.cmake
new file mode 100644
index 0000000..9d55d67
--- /dev/null
+++ b/cmake/FindMFRAVCtrl.cmake
@@ -0,0 +1,47 @@
+# If not stated otherwise in this file or this component's license file the
+# following copyright and licenses apply:
+#
+# Copyright 2020 RDK Management
+#
+# Licensed under the Apache License, Version 2.0 (the License);
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+# http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an AS IS BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# - Try to find MFRAVCTRL
+# Once done this will define
+#  MFRAVCTRL_FOUND - System has avctrl libraries
+#  MFRAVCTRL_INCLUDE_DIRS - avctrl include directories
+#  MFRAVCTRL_LIBRARIES - The libraries needed to use avctrl
+#
+
+find_package(PkgConfig)
+pkg_check_modules(MFRAVCTRL avctrl)
+
+include(FindPackageHandleStandardArgs)
+FIND_PACKAGE_HANDLE_STANDARD_ARGS(avctrllibs DEFAULT_MSG MFRAVCTRL_LIBRARIES)
+
+mark_as_advanced(MFRAVCTRL_INCLUDE_DIRS MFRAVCTRL_LIBRARIES)
+
+
+find_library(MFRAVCTRL_LIBRARY NAMES ${MFRAVCTRL_LIBRARIES}
+    HINTS ${MFRAVCTRL_LIBDIR} ${MFRAVCTRL_LIBRARY_DIRS}
+    )
+
+if(MFRAVCTRL_LIBRARY AND NOT TARGET avctrllibs::avctrllibs)
+    message("avctrl libs found")
+    add_library(avctrllibs::avctrllibs UNKNOWN IMPORTED)
+    set_target_properties(avctrllibs::avctrllibs PROPERTIES
+        IMPORTED_LOCATION "${MFRAVCTRL_LIBRARY}"
+        INTERFACE_LINK_LIBRARIES "${MFRAVCTRL_LIBRARIES}"
+        INTERFACE_COMPILE_OPTIONS "${MFRAVCTRL_DEFINITIONS}"
+        INTERFACE_INCLUDE_DIRECTORIES "${MFRAVCTRL_INCLUDE_DIRS}"
+        )
+endif()
-- 
2.24.0

